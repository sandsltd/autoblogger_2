function generateWorkflow(config) {
  const cronSchedule = config.schedule.cron === 'manual' 
    ? '0 9 * * 1' // Weekly on Monday if manual
    : convertToCronSyntax(config.schedule.cron);
  
  return `name: Generate Blog Post

on:
  schedule:
    # ${getScheduleDescription(config.schedule.cron)}
    - cron: '${cronSchedule}'
  workflow_dispatch: # Allow manual triggering

jobs:
  generate-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: \${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: \${{ runner.os }}-node-\${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            \${{ runner.os }}-node-
      
      - name: Generate blog post
        env:
          OPENAI_API_KEY: \${{ secrets.OPENAI_API_KEY }}
        run: |
          cd .blog-generator
          npm run generate
      
      ${config.framework === 'nextjs' || config.framework === 'gatsby' ? `- name: Rebuild static pages
        run: |
          npm ci
          npm run build
      
      ` : ''}${config.framework === 'gatsby' ? `- name: Clean Gatsby cache
        run: |
          npm run clean
      
      ` : ''}- name: Commit and push if changed
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .blog-generator/content/posts/ public/images/blog/ .blog-generator/topic-history.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add new blog post: \$(date +'%Y-%m-%d') [automated]
            
            Generated by SEO Blog Generator
            Business: ${config.business.name}
            Location: ${config.business.location}"
            git push
          fi
`;
}

function convertToCronSyntax(cronExpression) {
  // Convert from node-cron to GitHub Actions cron
  // GitHub Actions uses standard cron (minute hour day month weekday)
  // node-cron uses the same format, so mostly compatible
  
  // Special cases for our presets
  const conversions = {
    '0 * * * *': '0 * * * *',          // Every hour
    '0 */3 * * *': '0 */3 * * *',      // Every 3 hours
    '0 */6 * * *': '0 */6 * * *',      // Every 6 hours
    '0 9 * * *': '0 9 * * *',          // Daily at 9am
    '0 9,15 * * *': '0 9,15 * * *',    // Twice daily
  };
  
  return conversions[cronExpression] || '0 9 * * 1'; // Default to weekly
}

function getScheduleDescription(cron) {
  const descriptions = {
    '0 * * * *': 'Runs every hour',
    '0 */3 * * *': 'Runs every 3 hours',
    '0 */6 * * *': 'Runs every 6 hours',
    '0 9 * * *': 'Runs daily at 9am UTC',
    '0 9,15 * * *': 'Runs twice daily at 9am and 3pm UTC',
    'manual': 'Runs weekly on Monday at 9am UTC (manual mode selected)',
  };
  
  return descriptions[cron] || 'Custom schedule';
}

module.exports = { generateWorkflow };